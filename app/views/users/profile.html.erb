<%= content_for(:meta_title, "#{t('nlt.user_profile')} - #{@user.username}") %>

<div id="profile" class="row">

  <% if user_signed_in? and @user.id == current_user.id %>
    <h1 id="title"><%= 'Hola, ' %> <%= @user.name %></h1>
  <% end %>

  <div id="profile-block" class="col-md-3 col-sm-3 col-xs-12">
    <div class="profile-header">
      <span class="col-md-8 col-sm-8 col-xs-8">Perfil</span>
      <% if user_signed_in? and @user.id == current_user.id %>
        <span class="col-md-4 col-sm-4 col-xs-4"><%= link_to 'Editar', user_edit_path(@user, :class => "btn btn-azul") %></span>
      <% end %>
    </div><!--/profile-header-->

    <div class="profile-body">
      <div class="izda col-md-4">
        <%= image_tag @user.image.url(:thumb), :alt => "", :class => "avatar, img-responsive" %>
      </div><!--/izda-->

      <div class="dcha col-md-8">
        <p class="username"><%= @user.username %></p>
        <% if user_signed_in? and @user.id != current_user.id %>
        <p>Valora a este usuario: 
          <%= rating_for @user, "rating", :cancel => true, cancel_place: 'right', cancel_hint: 'Cancela esta valoración!' %></p>
        <% else %>
          <%= rating_for @user, "rating", disable_after_rate: true, imdb_avg: true %>
        <% end %>



      </div><!-- /dcha -->

      <div class="abajo col-md-12 col-sm-12 col-xs-12">
        <%#= image_tag "http://maps.google.com/maps/api/staticmap?size=300x100&sensor=false&zoom=13&markers=#{@user.zipcode}, #{@user.city}", :width => "100%", :alt => "Mapa'", :id => "mapa", :class => "img-responsive" %>
       <iframe width="100%" height="100" frameborder="0" style="border:0"
       src="https://www.google.com/maps/embed/v1/place?key=AIzaSyCZtag48hMPyRv9K0xppoqTstZmJ9DHS_Q
       &q=<%= @user.zipcode %>,<%= @user.city %>&zoom=10" allowfullscreen>
       </iframe>
        <p><%= t('nlt.member_since') %>: <%= l @user.created_at, format: "%d-%m-%Y" %></p>
        <p>Código Postal: <%= @user.zipcode %></p>
        <!--<p>[Mapa]</p>-->
        <p>Comida entregada: <span id="comidaentregada"><%= grams_to_kg(@user.total_quantity) %> kg</span></p>
      </div><!-- /abajo -->
    </div><!-- /profile-body -->

  <% if user_signed_in? and @user.id == current_user.id %>
    <div class="btn btn-rojo col-md-12"><%= link_to 'Nueva idea', new_my_idea_path %></div>
    <div class="btn btn-rojo col-md-12">
      <%#= link_to "+ #{t('nlt.to_publish_ad')}", @user.new_ad_path(type: type_n) %>
      <%= link_to "Comparte alimentos", new_ad_path %>
    </div>
  <% end %>

    <div id="profile-menu">
      <%#= render partial: "users/tabnav", locals: {user: @user} %>
      <% if user_signed_in? and @user.id == current_user.id %>
        <div class="btn btn-azul col-md-12">
          <%#= link_to_unless_current t('nlt.messages'), messages_list_path %>
          <% unread_messages_count = current_user.unread_messages_count %>
          <%= link_to messages_list_path, title: "#{unread_messages_count}" do %>
            Tienes <%= unread_messages_count %> mensaje(s) sin leer
          <% end %>
        </div>
          <%#= link_to t('nlt.logout'), destroy_user_session_path, :method => :delete, :class => "btn btn-azul" %>
        <% end %>
    </div><!-- /profile-menu -->
  </div><!-- /profile-block -->

<div class="col-md-9 col-sm-9 col-xs-12">

<p class="title-listados">Alimentos compartidos de <%= @user.username %></p>
<table id="table-alimentos" class="listados table table-responsive">
  <% if @user.ads.count > 0 %>
    <% @user.ads.each do |anuncio| %>

      <tr>
        <td><%= link_to image_tag(anuncio.image.url(:thumb), :alt => " ", :class => "img-responsive"), ad_url(anuncio) %>
          <p class="ad_status <%= anuncio.status_class %>"><%= anuncio.status_string %></p>
        </td>

        <td>
          <p class="grande enrojo"><%= link_to anuncio.title, ad_url(anuncio) %></p>
          <p class="enrojo"><%= grams_to_kg(anuncio.grams) %> kg</p>
          <p><b>Fecha límite de entrega:</b> <%= formated_date(anuncio.pick_up_date) %></p>
          <p><%= truncate_html(markdown(anuncio.body).html_safe, length: 150, omission: ' ... ') %></p>
        </td>
        <td>
          <div>
            <% if user_signed_in? and @user.id == current_user.id %>
              <p class="btn btn-azul col-md-12"><%= link_to 'Ver', ad_url(anuncio) %></p>
              <% if can? :update, anuncio %>
                <p class="btn btn-verde col-md-12"><%= link_to ads_edit_path(anuncio.id) do %>
                  Editar
              <% end %></p>
            <% end %>
            <!--<p class="btn btn-azul"><%#= link_to 'Previsualizar', my_idea_path(idea) %></p>
            <p class="btn btn-rojo"><%#= link_to 'Eliminar', my_idea_path(idea), method: :delete, data: { confirm: 'Seguro que quieres eliminar?' } %></p>-->
            <% end %>
          </div>
        </td>
        <% end %>
      <% else %>
        <p> <%= t("nlt.no_results.on_user") %> </p>
        </tr>
      <% end %>
  </table>

  <p class="title-listados">Ideas de <%= @user.username %></p>
  <table id="table-ideas" class="listados table table-responsive">
    <% @user.ideas.each do |idea| %>
    <tr>
      <td><%= link_to image_tag(idea.image.url(:thumb), :alt => " ", :class => "img-responsive"), idea_url(idea) %></td>
      <td>
        <p class="grande"><%= link_to idea.title, idea_url(idea) %></p>
        <p><%= truncate_html(markdown(idea.introduction).html_safe, length: 200, omission: ' ... ') %></p>
      </td>
      <td>
        <% if user_signed_in? and @user.id == current_user.id %>
          <p class="btn btn-azul col-md-12"><%= link_to 'Ver', idea_url(idea) %></p>
          <!--<p class="btn btn-azul"><%#= link_to 'Previsualizar', my_idea_path(idea) %></p>-->
          <p class="btn btn-verde col-md-12"><%= link_to 'Editar', edit_my_idea_path(idea) %></p>
          <p class="btn btn-rojo col-md-12"><%= link_to 'Eliminar', my_idea_path(idea), method: :delete, data: { confirm: 'Seguro que quieres eliminar?' } %></p>
        <% end %>
      </td>
    </tr>
    <% end %>
</table>

  <!--<h1 class="title-listados">Valoraciones pendientes <%= @user.username %></h1>
  <table id="listados">
    <tr>
      <td>bla</td>
    </tr>
  </table>-->

<hr>

    <ul>
      <% unless current_user == @user %>
        <li>
          <%= link_to message_new_path @user.id, :class => "world_link" do %>
           <%= t('nlt.send_a_message_to') %> <%= @user.username %>
           <%= image_tag "email_send.png", :alt => "send a mesage" %>
          <% end %>
        </li>
      <% end %>

      <!--<%# if user_signed_in? %>
        <%# unless current_user == @user %>
          <li>
          <%# if current_user.is_friend? @user %>
            <%#= link_to destroy_friend_path(@user.id), class: 'world_link', method: 'post' do %>
              <%#= t('nlt.profile_actions.friend.delete', username: @user.username) %>
              <%#= image_tag "friend_delete.png", alt: "Delete friend"%>
            <%# end %>
          <%# else %>
            <%#= link_to add_friend_path(@user.id), class: 'world_link', method: 'post' do %>
              <%#= t('nlt.profile_actions.friend.add', username: @user.username) %>
              <%#= image_tag "friend_add.png", alt: "Add friend"%>
            <%# end %>
          <%# end %>
            </li>
          <%# end %>
        <%# end %>-->

      <% if can? :lock, @user %>
        <li>
          <% if @user.locked? %>
            <%= link_to unlock_user_path(@user.id), data: {confirm: "¿Estas seguro que quieres desbloquear a este usuario? Podrá volver iniciar sesión."} do %>
              <%= t('nlt.admin.unlock_user') %>
              <%= image_tag "neu/24x24/actions/add.png" %>
            <% end %>
          <% else %>
            <%= link_to lock_user_path(@user.id), data: {confirm: "¿Estas seguro que quieres bloquear a este usuario? No podrá iniciar sesión."} do %>
              <%= t('nlt.admin.lock_user') %>
              <%= image_tag "neu/24x24/actions/remove.png" %>
            <% end %>
          <% end %>
        </li>
      <% end %>

      <% unless user_signed_in? and @user.id == current_user.id %>

        <% if can? :become, @user %>
          <li>
            <%= link_to t('nlt.admin.become_user'), become_user_path(@user.id) %>
          </li>
        <% end %>

      <% end %>

      <% unless @user.friends.count == 0 %>
        <div>
        <h4><%= t('nlt.friends') %>:</h4>
        <ul>
          <% @user.friends.each do |friend| %>
            <li>
              <%= link_to friend.username, profile_path(friend.username) %>
            </li>
          <% end %>
        </ul>
        <br>
        </div>
      <% end %>

  </div><!-- /ofertas-->
</div><!-- /profile -->


